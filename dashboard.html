<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3 Dashboard</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <script src="js/d3.js"></script>
</head>
<body>
  <div id="pieChart"></div>
  <div id="annualPerformance"></div>
  <div id="monthlyLineChart"></div>
  <script type="text/javascript">

    var formatAsCurrency = d3.format("$,"),
        formatAsPercentage = d3.format("%");

    /* PIE CHART */

    function drawPieChart() {
    	//Width, height, padding
    	var w = 400;
    	var h = 400;
      var p = 50;

    	var datasetPieChart = [
        {teamMember: "Sansa", portion: 0.30},
        {teamMember: "Arya", portion: 0.17},
        {teamMember: "Bran", portion: 0.13},
        {teamMember: "Robb", portion: 0.05},
        {teamMember: "Jon", portion: 0.35},
      ];

    	var outerRadius = w / 2;
    	var outerRadiusOut = w / 1.9;
      var innerRadiusInitial = outerRadius * 0.999;
      var innerRadius = w / 4;

    	var arc = d3.svg
                  .arc()
    							.innerRadius(innerRadiusInitial)
    							.outerRadius(outerRadius);
      var arcOut = d3.svg
                     .arc()
                     .innerRadius(innerRadius)
                     .outerRadius(outerRadiusOut);

      var arcIn = d3.svg
                    .arc()
                    .innerRadius(innerRadius)
                    .outerRadius(outerRadius);

    	var pie = d3.layout.pie()
                  .value(function(d) {
                    return d.portion;
                  });

    	//Color palette via colourlovers.com (u.make.me.happy)
    	var color = d3.scale.ordinal()
                    .domain(function(d){
                      return d.teamMember;
                    })
                    .range(["#5CACC4", "#8CD19D", "#CEE879", "#FCB653", "#FF5254"]);
                    //Alternative palette = Blue Eyes:
                    //.range(["#005FA8","#3777BD","#5A91CC","#88B4E3","#ACE"]);


    	//Create SVG element
    	var svg = d3.select("#pieChart")
      						.append("svg")
      						.attr("width", w+p)
      						.attr("height", h+p)
                  .style("border", "1px solid black");

    	//Set up groups
    	var arcs = svg.selectAll("g.arc")
      						  .data(pie(datasetPieChart))
      						  .enter()
      						  .append("g")
      						  .attr("class", "arc")
      						  .attr("transform", "translate(" + (outerRadius + p/2) + "," + (p/2 + outerRadius) + ")")
                    .on("mouseover", mouseover)
                    .on("mouseout", mouseout)
                    .on("click", update);

    	//Draw arc paths
    	arcs.append("path")
    	    .attr("fill", function(d, i) {
    	    	return color(i);
    	    })
    	    .attr("d", arc)
          .append("title")
          .text(function(d){ return d.data.teamMember + ": " + formatAsPercentage(d.data.portion); });

      //Initial animation
      d3.selectAll("path").transition()
        .duration(800)
        .delay(10)
        .attr("d", arcIn);

    	//Labels
    	arcs.append("text")
    	    .attr("transform", function(d) {
    	    	return "translate(" + arcIn.centroid(d) + ")";
    	    })
    	    .attr("text-anchor", "middle")
    	    .text(function(d) {
    	    	return d.data.teamMember;
    	    });

      //Title in the middle
      svg.append("text")
         .attr("dy", "14em")
         .attr("dx", "14em")
         .attr("text-anchor", "middle")
         .text("Revenue Share, 2014")
         .attr("class", "title");

      //Mouseover animations
      function mouseover(){
        d3.select(this).select("path").transition()
          .duration(300)
          .attr("d", arcOut);
      };

      function mouseout(){
        d3.select(this).select("path").transition()
          .duration(300)
          .attr("d", arcIn);
      };

      function update(d,i){
        updateAnnualPerformance(d.data.teamMember, color(i));
      }
    };

    drawPieChart();

    /* ANNUAL PERFORMANCE */

    var datasetAnnualPerformance = [
      {teamMember: "Total", performance: 5324880},
      {teamMember: "Sansa", performance: 1597440},
      {teamMember: "Arya", performance: 905216},
      {teamMember: "Bran", performance: 692224},
      {teamMember: "Robb", performance: 266240},
      {teamMember: "Jon", performance: 1863680},
    ];

    var teamMember = "Total";

    function datasetSelected(teamMember){
      var data = [];
      for (x in datasetAnnualPerformance) {
        if (datasetAnnualPerformance[x].teamMember == teamMember){
          data.push(datasetAnnualPerformance[x]);
        }
      }
      return data;
    };

    function drawAnnualPerformance(){

      var w = 400;
      var h = 200;

      var svg = d3.select("#annualPerformance").append("svg")
                  .data(datasetAnnualPerformance)
                  .attr("width", w)
                  .attr("height", h)
                  .style("border", "1px solid #000");

      var title = svg.append("g")
                     .attr("transform", "translate(115,50)");

      title.append("text")
           .text("Revenue to Date, 2014")
           .attr("class", "performanceTitle");

      svg.append("text")
         .attr("class", "performance")
         .attr("x", w/4.5)
         .attr("y", h/2)
         .style("fill", "#777")
         .transition()
         .duration(1000)
         .tween("text", function(d){
           var i = d3.interpolateRound(0, d.performance);
           return function(t) {
             this.textContent = formatAsCurrency(i(t));
           }
         });

    };

    drawAnnualPerformance();

    /* UPDATE ANNUAL PERFORMANCE */

    function updateAnnualPerformance(teamMember, color){

      var selectedAPData = datasetSelected(teamMember);

      var updateArea = d3.select("#annualPerformance .performance")
                         .data(selectedAPData);

      updateArea.transition()
                .duration(750)
                .style("fill", color)
                .tween("text", function(d){
                  var i = d3.interpolateRound(0, d.performance);
                  return function(t) {
                    this.textContent = formatAsCurrency(i(t));
                  }
                });
    };

    /* MONTHLY LINE CHART */

    function monthlyLineChart() {

      var w = 400;
      var h = 20;

      var svg = d3.select("#monthlyLineChart")
                  .append("svg");
    }

  </script>
</body>
</html>
